<?php

namespace Model\Cashbook;

use Cake\Chronos\Date;
use Model\Cashbook\Cashbook\CashbookType;
use Model\Cashbook\Cashbook\Chit;
use Model\Cashbook\Cashbook\Recipient;
use Model\Cashbook\Events\ChitWasRemoved;
use Model\Cashbook\Events\ChitWasUpdated;
use Mockery as m;

/**
 * These are in fact unit tests, that can't be tested without database right now, because chit ids are
 * autogenerated. This should be refactored to use composite keys ( @see \Model\Travel\Command ) and moved to unit suite
 */
class CashbookIntegrationTest extends \IntegrationTest
{

    public function getTestedEntites(): array
    {
        return [
            Cashbook::class,
            Chit::class,
        ];
    }

    public function testLockingLockedChitDoesNothing(): void
    {
        $cashbook = $this->createCashbookWithLockedChit();

        $cashbook->lockChit(1, 10);

        $this->assertEmpty($cashbook->extractEventsToDispatch());
    }

    public function testUnlockingUnlockedChitDoesNothing(): void
    {
        $cashbook = $this->createCashbookWithChit();

        $cashbook->unlockChit(1);

        $this->assertEmpty($cashbook->extractEventsToDispatch());
    }

    public function testUnlockedChitCanBeUpdated(): void
    {
        $cashbook = $this->createCashbookWithLockedChit();
        $category = $this->mockCategory(1);
        $amount = new Cashbook\Amount('100');
        $date = new Date('2017-11-17');
        $recipient = new Recipient('František Maša');

        $cashbook->unlockChit(1);
        $cashbook->updateChit(1, NULL, $date, $recipient, $amount, 'purpose', $category);

        $event = $cashbook->extractEventsToDispatch()[0];
        $this->assertInstanceOf(ChitWasUpdated::class, $event);
        /** @var ChitWasUpdated $event */
        $this->assertSame(10, $event->getCashbookId());
        $this->assertSame(666, $event->getOldCategoryId());
        $this->assertSame(1, $event->getNewCategoryId());
    }

    public function testUpdateOfLockedChitThrowsException(): void
    {
        $cashbook = $this->createCashbookWithLockedChit();
        $category = $this->mockCategory(666);
        $date = new Date('2017-11-17');
        $amount = new Cashbook\Amount('100');
        $this->expectException(ChitLockedException::class);

        $cashbook->updateChit(1, NULL, $date, NULL, $amount, 'new-purpose', $category);
    }

    public function testUpdateofNonExistentChitThrowsException(): void
    {
        $cashbook = $this->createCashbookWithChit();
        $category = $this->mockCategory(666);
        $amount = new Cashbook\Amount('100');
        $date = new Date('2017-11-17');

        $this->expectException(ChitNotFoundException::class);

        $cashbook->updateChit(2, NULL, $date,NULL, $amount, 'new-purpose', $category);
    }

    public function testRemoveChit(): void
    {
        $cashbook = $this->createCashbookWithChit();

        $cashbook->removeChit(1);

        $this->assertSame([], $cashbook->getCategoryTotals()); // no chits => no categories

        $event = $cashbook->extractEventsToDispatch()[0];
        $this->assertInstanceOf(ChitWasRemoved::class, $event);
        /** @var ChitWasRemoved $event */
        $this->assertSame(10, $event->getCashbookId());
        $this->assertSame('purpose', $event->getChitPurpose());
    }

    public function testRemovalOfLockedChitThrowsException()
    {
        $cashbook = $this->createCashbookWithLockedChit();

        $this->expectException(ChitLockedException::class);

        $cashbook->removeChit(1);
    }

    public function testRemovalOfNonExistentChitThrowsException()
    {
        $cashbook = $this->createCashbookWithChit();

        $this->expectException(ChitNotFoundException::class);

        $cashbook->removeChit(2);
    }

    private function createCashbookWithLockedChit(): Cashbook
    {
        $cashbook = $this->createCashbookWithChit();
        $cashbook->lockChit(1, 10);
        $cashbook->extractEventsToDispatch();

        return $cashbook;
    }

    private function createCashbookWithChit(): Cashbook
    {
        $cashbook = new Cashbook(10, CashbookType::get(CashbookType::EVENT));
        $category = $this->mockCategory(666);
        $amount = new Cashbook\Amount('100');
        $date = new Date('2017-11-17');

        $cashbook->addChit(NULL, $date, NULL, $amount, 'purpose', $category);
        $cashbook->extractEventsToDispatch();

        // This assigns ID 1 to chit
        $this->entityManager->persist($cashbook);
        $this->entityManager->flush();

        return $cashbook;
    }

    public function testLock(): void
    {
        $cashbook = new Cashbook(11, CashbookType::get(CashbookType::EVENT));

        for ($i = 0; $i < 5; $i++) {
            $cashbook->addChit(
                NULL,
                new Date('2017-11-17'),
                NULL,
                new Cashbook\Amount('100'),
                'purpose',
                $this->mockCategory(666)
            );
        }

        $this->entityManager->persist($cashbook);
        $this->entityManager->flush();

        $cashbook->lockChit(3, 1);


        $cashbook->lock(1);

        $chits = $cashbook->getChits();

        $this->assertCount(5, $chits);
        foreach($chits as $chit) {
            $this->assertTrue($chit->isLocked());
        }
    }

    private function mockCategory(int $id): ICategory
    {
        return m::mock(ICategory::class, [
            'getId' => $id,
            'getOperationType' => Operation::get(Operation::INCOME),
        ]);
    }

}
